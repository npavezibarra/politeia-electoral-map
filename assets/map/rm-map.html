<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Politeia Electoral Map – RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    #app {
      position: relative;
      width: 100%;
      height: 100%;
      background: #f5f6f8;
    }
    #map {
      position: absolute;
      inset: 0;
    }

    /* Search UI */
    .toolbar {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, calc(100% - 24px));
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
    }
    .search input {
      width: 100%;
      font-size: 16px;
      border: none;
      outline: none;
      background: transparent;
    }
    .suggestions {
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
      display: none;
      max-height: 280px;
      overflow-y: auto;
    }
    .suggestions.visible { display: block; }
    .suggestion {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid rgba(0,0,0,.04);
      font-size: 15px;
    }
    .suggestion:last-child { border-bottom: none; }
    .suggestion:hover { background: #f4f7ff; }
    .suggestion small { color: #6b7280; }

    /* Info chip bottom-left */
    .chip {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 4;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      color: #111827;
      box-shadow: 0 6px 18px rgba(0,0,0,.10), 0 1px 4px rgba(0,0,0,.06);
      max-width: min(50vw, 420px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Tiny help */
    .hint {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      text-shadow: 0 1px 2px rgba(255,255,255,.8);
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map" aria-label="Mapa Región Metropolitana"></div>

    <div class="toolbar" role="search" aria-label="Buscador de comunas">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" fill="none" stroke="#4b5563" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" type="search" placeholder="Busca una comuna de la RM (ej: Las Condes, Maipú, Puente Alto…)" autocomplete="off" />
      </div>
      <div id="suggestions" class="suggestions" role="listbox" aria-label="Sugerencias"></div>
      <div class="hint">Doble clic sobre una comuna para centrarla. Pasa el mouse para ver el nombre.</div>
    </div>

    <div id="chip" class="chip" aria-live="polite">Cargando mapa…</div>
  </div>

  <script>
    // --- Utilidades ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // Normaliza texto para buscar: minúsculas, sin tildes
    const norm = (s) => (s || '')
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim();

    // Lee api_key de la URL del iframe
    const params = new URLSearchParams(location.search);
    const API_KEY = params.get('api_key') || '';

    // Ruta al GeoJSON respecto a este HTML:
    const GEOJSON_URL = '../geojson/comunas.geojson';

    // Centro aproximado RM
    const RM_CENTER = { lat: -33.45, lng: -70.66 };
    const RM_ZOOM = 9;

    // Estado
    let map;
    let highlighted = null;
    const idxByName = new Map(); // name_norm -> {name, provincia, feature}
    const featuresRM = [];        // lista de features (RM) para iterar

    // --- Inyecta Google Maps JS dinámicamente ---
    (function injectMaps() {
      if (!API_KEY) {
        $('#chip').textContent = 'Falta api_key en la URL del iframe (configúrala en WP Admin).';
        console.warn('No API key. Agrega ?api_key=YOUR_KEY al src del iframe.');
        return;
      }
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();

    // --- Helpers de propiedades según dataset observado ---
    function getCodRegion(feature) {
      // Posibles claves según distintos datasets
      const keys = ['codregion', 'CodigoRegion', 'COD_REGION', 'REGION_ID', 'region_id', 'c_region'];
      for (const k of keys) {
        const v = feature.getProperty(k);
        if (v !== undefined && v !== null && v !== '') return v;
      }
      // Fallback semántico: por nombre textual
      const regName = feature.getProperty('Region') || feature.getProperty('REGION') || feature.getProperty('region');
      if (regName && /metropolitana/i.test(regName)) return 13;
      return null;
    }

    function getComunaName(feature) {
      const keys = ['Comuna','COMUNA','NOM_COMUNA','name','Nombre','nom_com','NOM_COM','comuna'];
      for (const k of keys) {
        const v = feature.getProperty(k);
        if (v) return String(v);
      }
      return 'Sin nombre';
    }

    function getProvinciaName(feature) {
      const keys = ['Provincia','PROVINCIA','provincia','NOM_PROV','nom_prov'];
      for (const k of keys) {
        const v = feature.getProperty(k);
        if (v) return String(v);
      }
      return '';
    }

    // Estilo por estado
    function styleFeature(feature) {
      const isH = !!feature.getProperty('isHighlighted');
      return {
        fillColor: isH ? '#3b82f6' : '#2563eb',
        fillOpacity: isH ? 0.28 : 0.14,
        strokeColor: isH ? '#1d4ed8' : '#1e40af',
        strokeOpacity: 0.9,
        strokeWeight: isH ? 2.6 : 1.6,
        clickable: true,
        zIndex: isH ? 2 : 1
      };
    }

    // Resalta solo una comuna
    function highlight(feature) {
      if (highlighted && highlighted !== feature) {
        highlighted.setProperty('isHighlighted', false);
      }
      highlighted = feature;
      if (feature) feature.setProperty('isHighlighted', true);
      map.data.setStyle(styleFeature);
    }

    // Ajusta el mapa a la geometría de la feature
    function fitFeature(feature) {
      const bounds = new google.maps.LatLngBounds();
      processGeometry(feature.getGeometry(), bounds.extend, bounds);
      map.fitBounds(bounds, { top: 80, right: 20, bottom: 20, left: 20 });
    }

    // Recorre geometrías (Polygon/MultiPolygon)
    function processGeometry(geom, callback, thisArg) {
      if (geom instanceof google.maps.Data.Point) {
        callback.call(thisArg, geom.get());
      } else {
        geom.getArray().forEach(g => processGeometry(g, callback, thisArg));
      }
    }

    // Construye índice de búsqueda
    function indexFeature(feature) {
      const name = getComunaName(feature);
      const provincia = getProvinciaName(feature);
      const key = norm(name);
      idxByName.set(key, { name, provincia, feature });
      featuresRM.push(feature);
    }

    // Renderiza sugerencias
    function renderSuggestions(items) {
      const box = $('#suggestions');
      if (!items.length) {
        box.classList.remove('visible');
        box.innerHTML = '';
        return;
      }
      box.innerHTML = items.map(it => `
        <div class="suggestion" role="option" data-key="${it.key}">
          <span>${it.name}</span>
          ${it.provincia ? `<small>${it.provincia}</small>` : ''}
        </div>
      `).join('');
      box.classList.add('visible');

      // Click en sugerencia
      $$('#suggestions .suggestion').forEach(el => {
        el.addEventListener('click', () => {
          const k = el.getAttribute('data-key');
          selectByKey(k);
        });
      });
    }

    // Selección desde el índice por key normalizada
    function selectByKey(key) {
      const hit = idxByName.get(key);
      if (!hit) return;
      highlight(hit.feature);
      fitFeature(hit.feature);
      $('#q').value = hit.name;
      $('#chip').textContent = `${hit.name}${hit.provincia ? `, ${hit.provincia}` : ''}`;
      $('#suggestions').classList.remove('visible');
    }

    // Búsqueda incremental
    function search(query) {
      const q = norm(query);
      if (!q) return [];

      const all = [];
      for (const [key, meta] of idxByName.entries()) {
        if (key.startsWith(q)) {
          all.push({ key, ...meta, score: 0 }); // mayor prioridad
        } else if (key.includes(q)) {
          all.push({ key, ...meta, score: 1 });
        }
      }
      // Orden: startsWith primero, luego por nombre
      all.sort((a,b) => a.score - b.score || a.name.localeCompare(b.name, 'es'));
      return all.slice(0, 12);
    }

    // --- Callback global para Google Maps ---
    window.initMap = function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: RM_CENTER,
        zoom: RM_ZOOM,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        clickableIcons: false,
        gestureHandling: 'greedy',
        styles: [
          { featureType: 'poi', stylers: [{ visibility: 'off' }] },
          { featureType: 'transit', stylers: [{ visibility: 'off' }] }
        ]
      });

      // Estilo base
      map.data.setStyle(styleFeature);

      // Eventos de UI
      map.data.addListener('mouseover', (e) => {
        const name = getComunaName(e.feature);
        $('#chip').textContent = name;
        // borde al pasar
        e.feature.setProperty('hover', true);
        map.data.overrideStyle(e.feature, {
          strokeWeight: e.feature.getProperty('isHighlighted') ? 3 : 2.2,
          fillOpacity: e.feature.getProperty('isHighlighted') ? 0.32 : 0.20
        });
      });

      map.data.addListener('mouseout', (e) => {
        const txt = highlighted ? getComunaName(highlighted) : 'Pasa el mouse por una comuna o búscala arriba.';
        $('#chip').textContent = txt;
        map.data.revertStyle(e.feature);
      });

      map.data.addListener('dblclick', (e) => {
        highlight(e.feature);
        fitFeature(e.feature);
        const name = getComunaName(e.feature);
        const provincia = getProvinciaName(e.feature);
        $('#q').value = name;
        $('#chip').textContent = `${name}${provincia ? `, ${provincia}` : ''}`;
      });

      // Cargar GeoJSON y filtrar RM
      $('#chip').textContent = 'Cargando límites comunales…';
      map.data.loadGeoJson(GEOJSON_URL, null, () => {
        // Filtra solo codregion 13 (aceptando string/number) o Region textual
        const toRemove = [];
        map.data.forEach((f) => {
          const cr = getCodRegion(f);
          const keep =
            cr === 13 ||
            cr === '13' ||
            /metropolitana/i.test(String(f.getProperty('Region') || f.getProperty('REGION') || ''));
          if (!keep) toRemove.push(f);
        });
        toRemove.forEach(f => map.data.remove(f));

        // Indexar y setear estado inicial
        map.data.forEach((f) => indexFeature(f));
        $('#chip').textContent = 'RM lista. Busca una comuna o haz doble clic sobre el mapa.';

        // Si llega ?q=las%20condes en la URL, selecciona
        const qParam = params.get('q');
        if (qParam) {
          const hits = search(qParam);
          if (hits.length) selectByKey(hits[0].key);
        }
      });

      // Search listeners
      const input = $('#q');
      const box = $('#suggestions');

      input.addEventListener('input', () => {
        const q = input.value;
        const items = search(q);
        renderSuggestions(items);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const items = search(input.value);
          if (items.length) {
            selectByKey(items[0].key);
            e.preventDefault();
          } else {
            box.classList.remove('visible');
          }
        } else if (e.key === 'Escape') {
          box.classList.remove('visible');
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.toolbar')) {
          box.classList.remove('visible');
        }
      });
    };
  </script>
</body>
</html>
