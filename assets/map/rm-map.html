<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Politeia Electoral Map – RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { position: relative; width: 100%; height: 100%; }
    #map { position: absolute; inset: 0; }

    .toolbar {
      position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
      width: min(720px, calc(100% - 24px)); z-index: 5; display: flex; flex-direction: column; gap: 6px;
    }
    .search {
      display: flex; align-items: center; gap: 8px; background: #fff; border-radius: 10px; padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.06);
    }
    .search input { width: 100%; font-size: 16px; border: none; outline: none; background: transparent; }
    .suggestions {
      background: #fff; border: 1px solid rgba(0,0,0,.08); border-radius: 10px; overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
      display: none; max-height: 280px; overflow-y: auto;
    }
    .suggestions.visible { display: block; }
    .suggestion { padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,.04); font-size: 15px; }
    .suggestion:last-child { border-bottom: none; }
    .suggestion:hover { background: #f4f7ff; }
    .suggestion small { color: #6b7280; }

    .chip {
      position: absolute; left: 14px; bottom: 14px; z-index: 4; background: rgba(255,255,255,.96);
      border: 1px solid rgba(0,0,0,.06); border-radius: 10px; padding: 8px 10px; font-size: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.10), 0 1px 4px rgba(0,0,0,.06);
      max-width: min(50vw, 420px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .hint { font-size: 12px; color: #6b7280; text-align: center; text-shadow: 0 1px 2px rgba(255,255,255,.8); }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="Busca una comuna de la RM (ej: Las Condes, Maipú…)" autocomplete="off" />
      </div>
      <div id="suggestions" class="suggestions"></div>
      <div class="hint">Doble clic en una comuna para centrarla. Pasa el mouse para ver el nombre.</div>
    </div>

    <div id="chip" class="chip">Cargando mapa…</div>
  </div>

  <script>
    // --- Parámetros y rutas ---
    const params = new URLSearchParams(location.search);
    const API_KEY = params.get('api_key') || '';
    const GEOJSON_URL = '../geojson/comunas_rm_oficial_wgs84.geojson'; // ya solo RM en WGS84

    // --- Estado ---
    let map, highlighted = null;
    const idxByName = new Map();

    // --- Utils ---
    const norm = s => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();

    function comunaName(feature) {
      const keys = ['Comuna','COMUNA','NOM_COMUNA','name'];
      for (const k of keys) { const v = feature.getProperty(k); if (v) return v; }
      return 'Sin nombre';
    }

    function provinciaName(feature) {
      const keys = ['Provincia','PROVINCIA'];
      for (const k of keys) { const v = feature.getProperty(k); if (v) return v; }
      return '';
    }

    function styleFeature(feature) {
      const isH = !!feature.getProperty('isHighlighted');
      return {
        fillColor: isH ? '#3b82f6' : '#2563eb',
        fillOpacity: isH ? 0.28 : 0.14,
        strokeColor: isH ? '#1d4ed8' : '#1e40af',
        strokeWeight: isH ? 2.6 : 1.6
      };
    }

    function highlight(feature) {
      if (highlighted && highlighted !== feature) highlighted.setProperty('isHighlighted', false);
      highlighted = feature;
      if (feature) feature.setProperty('isHighlighted', true);
      map.data.setStyle(styleFeature);
    }

    // --- Fit con offset a "2/3 derecha" (configurable) ---
    function fitFeatureWithOffset(feature, {
      padding = { top: 80, right: 20, bottom: 20, left: 20 },
      xRatio = 2/3,   // 0 = borde izq … 0.5 = centro … 1 = borde der
      yRatio = 0.5    // 0 = arriba … 0.5 = centro … 1 = abajo
    } = {}) {
      const bounds = new google.maps.LatLngBounds();
      feature.getGeometry().forEachLatLng(p => bounds.extend(p));

      // 1) Ajusta a los límites
      map.fitBounds(bounds, padding);

      // 2) Cuando el mapa termina de ajustar, aplica panBy para desplazar el "punto medio"
      google.maps.event.addListenerOnce(map, 'idle', () => {
        const div = map.getDiv();
        const w = div.clientWidth, h = div.clientHeight;
        const panX = (0.5 - xRatio) * w; // xRatio=2/3 -> panX negativo (centro se mueve hacia la izq, dejando comuna en 2/3 der)
        const panY = (0.5 - yRatio) * h;
        map.panBy(panX, panY);
      });
    }

    function buildIndex(feature) {
      const name = comunaName(feature);
      const provincia = provinciaName(feature);
      idxByName.set(norm(name), { name, provincia, feature });
    }

    function renderSuggestions(items) {
      const box = document.getElementById('suggestions');
      if (!items.length) { box.classList.remove('visible'); box.innerHTML = ''; return; }
      box.innerHTML = items.map(it => `
        <div class="suggestion" data-key="${it.key}">
          <span>${it.name}</span>${it.provincia ? `<small>${it.provincia}</small>` : ''}
        </div>`).join('');
      box.classList.add('visible');
      box.querySelectorAll('.suggestion').forEach(el => el.addEventListener('click', () => selectByKey(el.dataset.key)));
    }

    function selectByKey(key) {
      const hit = idxByName.get(key);
      if (!hit) return;
      highlight(hit.feature);
      fitFeatureWithOffset(hit.feature, { xRatio: 2/3, yRatio: 0.5 }); // <-- CORREGIDO
      document.getElementById('q').value = hit.name;
      document.getElementById('chip').textContent = hit.name;
      document.getElementById('suggestions').classList.remove('visible');
    }

    function search(q) {
      const nq = norm(q);
      if (!nq) return [];
      const all = [];
      for (const [key, meta] of idxByName.entries()) {
        if (key.startsWith(nq)) all.push({ key, ...meta, score: 0 });
        else if (key.includes(nq)) all.push({ key, ...meta, score: 1 });
      }
      all.sort((a,b) => a.score - b.score || a.name.localeCompare(b.name,'es'));
      return all.slice(0, 12);
    }

    // --- Google Maps bootstrap ---
    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -33.45, lng: -70.66 }, zoom: 9,
        mapTypeControl: false, streetViewControl: false, fullscreenControl: true, clickableIcons: false
      });
      map.data.setStyle(styleFeature);

      map.data.addListener('mouseover', e => { document.getElementById('chip').textContent = comunaName(e.feature); });
      map.data.addListener('mouseout',  e => { document.getElementById('chip').textContent = highlighted ? comunaName(highlighted) : 'Selecciona una comuna'; });
      map.data.addListener('dblclick',  e => {
        highlight(e.feature);
        fitFeatureWithOffset(e.feature, { xRatio: 2/3, yRatio: 0.5 });   // <-- CORREGIDO
        document.getElementById('q').value = comunaName(e.feature);
        document.getElementById('chip').textContent = comunaName(e.feature);
      });

      map.data.loadGeoJson(GEOJSON_URL, null, () => {
        map.data.forEach(f => buildIndex(f));
        document.getElementById('chip').textContent = 'Mapa listo.';
      });

      const input = document.getElementById('q');
      const box = document.getElementById('suggestions');
      input.addEventListener('input',   () => renderSuggestions(search(input.value)));
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const hits = search(input.value);
          if (hits.length) selectByKey(hits[0].key);
        } else if (e.key === 'Escape') box.classList.remove('visible');
      });
      document.addEventListener('click', e => { if (!e.target.closest('.toolbar')) box.classList.remove('visible'); });
    };

    if (API_KEY) {
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    } else {
      document.getElementById('chip').textContent = 'Falta api_key en el iframe (?api_key=)';
    }
  </script>
</body>
</html>
