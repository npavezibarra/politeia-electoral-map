<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Politeia Electoral Map – RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { position: relative; width: 100%; height: 100%; }
    #map { position: absolute; inset: 0; }

    .toolbar {
      position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
      width: min(720px, calc(100% - 24px)); z-index: 5; display: flex; flex-direction: column; gap: 6px;
    }
    .search {
      display: flex; align-items: center; gap: 8px; background: #fff; border-radius: 10px; padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.06);
    }
    .search input { width: 100%; font-size: 16px; border: none; outline: none; background: transparent; }
    .suggestions {
      background: #fff; border: 1px solid rgba(0,0,0,.08); border-radius: 10px; overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
      display: none; max-height: 280px; overflow-y: auto;
    }
    .suggestions.visible { display: block; }
    .suggestion { padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,.04); font-size: 15px; }
    .suggestion:last-child { border-bottom: none; }
    .suggestion:hover { background: #f4f7ff; }
    .suggestion small { color: #6b7280; }

    .chip {
      position: absolute; left: 14px; bottom: 14px; z-index: 4; background: rgba(255,255,255,.96);
      border: 1px solid rgba(0,0,0,.06); border-radius: 10px; padding: 8px 10px; font-size: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.10), 0 1px 4px rgba(0,0,0,.06);
      max-width: min(50vw, 420px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Panel de información (350px width, auto height) */
    #comune-info-card {
      position: absolute; top: 15%; left: 20px; z-index: 4;
      width: 350px; background: #fff; display: none;
      box-shadow: 0 6px 18px rgba(0,0,0,.10), 0 1px 4px rgba(0,0,0,.06);
      border-radius: 10px; overflow: hidden;
    }
    #INFOCARD-HEADER, #INFOCARD-COMMUNE {
      padding: 20px;
      font-size: 14px;
      line-height: 1.4;
    }
    #INFOCARD-HEADER {
      border-bottom: 1px solid rgba(0,0,0,.1);
    }
    #info-mayor {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    #info-mayor-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #d1d5db;
    }
    #info-term-bar {
      width: 100%; height: 6px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 4px 0;
    }
    #info-term-progress {
      height: 100%; background: #3b82f6; width: 0%;
    }
    #info-term {
      text-align: center;
      margin-bottom: 20px;
    }
    #info-term-dates {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
    }
    #info-term-label {
      font-size: 10px;
      letter-spacing: 4px;
    }
    #info-header-name {
      font-size: 28px;
      font-weight: 700;
    }
    #info-mayor-name {
      font-size: 20px;
    }

    .hint { font-size: 12px; color: #6b7280; text-align: center; text-shadow: 0 1px 2px rgba(255,255,255,.8); }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="Busca una comuna de la RM (ej: Las Condes, Maipú…)" autocomplete="off" />
      </div>
      <div id="suggestions" class="suggestions"></div>
      <div class="hint">Doble clic en una comuna para centrarla. Pasa el mouse para ver el nombre.</div>
    </div>

    <div id="chip" class="chip">Cargando mapa…</div>
    <div id="comune-info-card">
      <div id="INFOCARD-HEADER">
        <div id="info-header-type">Comuna</div>
        <div id="info-header-name"></div>
      </div>
      <div id="INFOCARD-COMMUNE">
        <div id="info-mayor">
          <div id="info-mayor-photo"></div>
          <div id="info-mayor-details">
            <div id="info-mayor-name"></div>
            <div id="info-office-party"></div>
          </div>
        </div>
        <div id="info-term">
          <div id="info-term-label">PERÍODO</div>
          <div id="info-term-bar"><div id="info-term-progress"></div></div>
          <div id="info-term-dates">
            <span id="info-term-start"></span>
            <span id="info-term-end"></span>
          </div>
        </div>
        <div id="info-votes"></div>
        <div id="info-budget"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Parámetros y rutas ---
    const params = new URLSearchParams(location.search);
    const API_KEY = params.get('api_key') || '';
    const GEOJSON_URL = '../geojson/comunas_rm_oficial_wgs84.geojson';

    // --- Estado ---
    let map, highlighted = null;
    const idxByName = new Map();

    // --- Utils ---
    const norm = s => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();

    function comunaName(feature) {
      const keys = ['Comuna','COMUNA','NOM_COMUNA','name'];
      for (const k of keys) { const v = feature.getProperty(k); if (v) return v; }
      return 'Sin nombre';
    }

    function provinciaName(feature) {
      const keys = ['Provincia','PROVINCIA'];
      for (const k of keys) { const v = feature.getProperty(k); if (v) return v; }
      return '';
    }

    function styleFeature(feature) {
      const isH = !!feature.getProperty('isHighlighted');
      return {
        fillColor: isH ? '#3b82f6' : '#2563eb',
        fillOpacity: isH ? 0.28 : 0.14,
        strokeColor: isH ? '#1d4ed8' : '#1e40af',
        strokeWeight: isH ? 2.6 : 1.6
      };
    }

    function highlight(feature) {
      if (highlighted && highlighted !== feature) highlighted.setProperty('isHighlighted', false);
      highlighted = feature;
      if (feature) feature.setProperty('isHighlighted', true);
      map.data.setStyle(styleFeature);
    }

    async function showInfo(name) {
      const box = document.getElementById('comune-info-card');
      const headerName = document.getElementById('info-header-name');
      const mayorName = document.getElementById('info-mayor-name');
      const officeParty = document.getElementById('info-office-party');
      const termStart = document.getElementById('info-term-start');
      const termEnd = document.getElementById('info-term-end');
      const termProgress = document.getElementById('info-term-progress');
      const votesEl = document.getElementById('info-votes');
      const budgetEl = document.getElementById('info-budget');

      if (headerName) headerName.textContent = name;
      if (mayorName) mayorName.textContent = '';
      if (officeParty) officeParty.textContent = '';
      if (termStart) termStart.textContent = '';
      if (termEnd) termEnd.textContent = '';
      if (termProgress) termProgress.style.width = '0%';
      if (votesEl) votesEl.textContent = '';
      if (budgetEl) budgetEl.textContent = '';

      try {
        const res = await fetch(`/wp-json/politeia/v1/jurisdictions?name=${encodeURIComponent(name)}`);
        if (res.ok) {
          const data = await res.json();
          if (data.found) {
            if (headerName && data.common_name) headerName.textContent = data.common_name;
            if (mayorName) mayorName.textContent = data.person_name || '';
            if (officeParty) {
              const parts = [];
              if (data.office_title) parts.push(data.office_title);
              if (data.party_short_name) parts.push(data.party_short_name);
              officeParty.textContent = parts.join(', ');
            }
            if (termStart) termStart.textContent = data.started_on || '';
            if (termEnd) termEnd.textContent = data.planned_end_on || '';
            if (termProgress && data.started_on && data.planned_end_on) {
              const start = new Date(data.started_on);
              const end = new Date(data.planned_end_on);
              const now = new Date();
              const ratio = Math.min(Math.max((now - start) / (end - start), 0), 1);
              termProgress.style.width = (ratio * 100) + '%';
            }
            if (votesEl && data.votes !== null && data.votes !== undefined) {
              votesEl.textContent = `${Number(data.votes).toLocaleString('es-CL')} votos`;
            }
            if (budgetEl && data.budget !== null && data.budget !== undefined) {
              budgetEl.textContent = `Presupuesto Anual Municipal: $${Number(data.budget).toLocaleString('es-CL')}`;
            }
          } else if (mayorName) {
            mayorName.textContent = 'No hay datos disponibles.';
          }
        } else if (mayorName) {
          mayorName.textContent = 'Error al cargar datos.';
        }
      } catch (e) {
        if (mayorName) mayorName.textContent = 'Error al cargar datos.';
      }

      box.style.display = 'block';
    }

    // --- Fit con offset a "2/3 derecha" (configurable) ---
    function fitFeatureWithOffset(feature, {
      padding = { top: 80, right: 20, bottom: 20, left: 20 },
      xRatio = 2/3,   // 0 = borde izq … 0.5 = centro … 1 = borde der
      yRatio = 0.5,   // 0 = arriba … 0.5 = centro … 1 = abajo
      onDone = null
    } = {}) {
      const bounds = new google.maps.LatLngBounds();
      feature.getGeometry().forEachLatLng(p => bounds.extend(p));

      // 1) Ajusta a los límites
      map.fitBounds(bounds, padding);

      // 2) Cuando termina, desplaza para dejar la comuna en ~2/3 der.
      google.maps.event.addListenerOnce(map, 'idle', () => {
        const div = map.getDiv();
        const w = div.clientWidth, h = div.clientHeight;
        const panX = (0.5 - xRatio) * w;
        const panY = (0.5 - yRatio) * h;
        map.panBy(panX, panY);
        if (typeof onDone === 'function') {
          google.maps.event.addListenerOnce(map, 'idle', onDone);
        }
      });
    }

    function buildIndex(feature) {
      const name = comunaName(feature);
      const provincia = provinciaName(feature);
      idxByName.set(norm(name), { name, provincia, feature });
    }

    function renderSuggestions(items) {
      const box = document.getElementById('suggestions');
      if (!items.length) { box.classList.remove('visible'); box.innerHTML = ''; return; }
      box.innerHTML = items.map(it => `
        <div class="suggestion" data-key="${it.key}">
          <span>${it.name}</span>${it.provincia ? `<small>${it.provincia}</small>` : ''}
        </div>`).join('');
      box.classList.add('visible');
      box.querySelectorAll('.suggestion').forEach(el => el.addEventListener('click', () => selectByKey(el.dataset.key)));
    }

    function selectByKey(key) {
      const hit = idxByName.get(key);
      if (!hit) return;
      highlight(hit.feature);
      fitFeatureWithOffset(hit.feature, { xRatio: 2/3, yRatio: 0.5, onDone: () => showInfo(hit.name) });
      document.getElementById('q').value = hit.name;
      document.getElementById('chip').textContent = hit.name;
      document.getElementById('suggestions').classList.remove('visible');
    }

    function search(q) {
      const nq = norm(q);
      if (!nq) return [];
      const all = [];
      for (const [key, meta] of idxByName.entries()) {
        if (key.startsWith(nq)) all.push({ key, ...meta, score: 0 });
        else if (key.includes(nq)) all.push({ key, ...meta, score: 1 });
      }
      all.sort((a,b) => a.score - b.score || a.name.localeCompare(b.name,'es'));
      return all.slice(0, 12);
    }

    // --- Google Maps bootstrap ---
    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -33.45, lng: -70.66 }, zoom: 9,
        mapTypeControl: false, streetViewControl: false, fullscreenControl: true, clickableIcons: false
      });
      map.data.setStyle(styleFeature);

      map.data.addListener('mouseover', e => { document.getElementById('chip').textContent = comunaName(e.feature); });
      map.data.addListener('mouseout',  e => { document.getElementById('chip').textContent = highlighted ? comunaName(highlighted) : 'Selecciona una comuna'; });
      map.data.addListener('dblclick',  e => {
        const name = comunaName(e.feature);
        highlight(e.feature);
        fitFeatureWithOffset(e.feature, { xRatio: 2/3, yRatio: 0.5, onDone: () => showInfo(name) });
        document.getElementById('q').value = name;
        document.getElementById('chip').textContent = name;
      });

      map.data.loadGeoJson(GEOJSON_URL, null, () => {
        map.data.forEach(f => buildIndex(f));
        document.getElementById('chip').textContent = 'Mapa listo.';
      });

      const input = document.getElementById('q');
      const box = document.getElementById('suggestions');
      input.addEventListener('input',   () => renderSuggestions(search(input.value)));
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const hits = search(input.value);
          if (hits.length) selectByKey(hits[0].key);
        } else if (e.key === 'Escape') box.classList.remove('visible');
      });
      document.addEventListener('click', e => { if (!e.target.closest('.toolbar')) box.classList.remove('visible'); });
    };

    if (API_KEY) {
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    } else {
      document.getElementById('chip').textContent = 'Falta api_key en el iframe (?api_key=)';
    }
  </script>
</body>
</html>
