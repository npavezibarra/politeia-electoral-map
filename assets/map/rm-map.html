<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Politeia Electoral Map – RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    #app {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    .toolbar {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, calc(100% - 24px));
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .12), 0 2px 6px rgba(0, 0, 0, .06);
      border: 1px solid rgba(0, 0, 0, .06);
    }

    .search input {
      width: 100%;
      font-size: 16px;
      border: none;
      outline: none;
      background: transparent;
    }

    .suggestions {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .08);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .12), 0 2px 6px rgba(0, 0, 0, .06);
      display: none;
      max-height: 280px;
      overflow-y: auto;
    }

    .suggestions.visible {
      display: block;
    }

    .suggestion {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0, 0, 0, .04);
      font-size: 15px;
    }

    .suggestion:last-child {
      border-bottom: none;
    }

    .suggestion:hover {
      background: #f4f7ff;
    }

    .suggestion small {
      color: #6b7280;
    }

    .chip {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 4;
      background: rgba(255, 255, 255, .96);
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .10), 0 1px 4px rgba(0, 0, 0, .06);
      max-width: min(50vw, 420px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Panel de información (350px width, auto height) */
    #comune-info-card {
      position: absolute;
      top: 15%;
      left: 20px;
      z-index: 4;
      width: 350px;
      background: #fff;
      display: none;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .10), 0 1px 4px rgba(0, 0, 0, .06);
      border-radius: 10px;
      overflow: hidden;
    }

    #INFOCARD-HEADER,
    #INFOCARD-COMMUNE {
      padding: 20px;
      font-size: 14px;
      line-height: 1.4;
    }

    #INFOCARD-HEADER {
      border-bottom: 1px solid rgba(0, 0, 0, .1);
    }

    #info-mayor {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    #info-mayor-details {
      width: 218px;
    }

    #info-mayor-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    #info-mayor-party {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
    }

    #info-mayor-photo {
      width: 80px;
      /* Fixed width */
      height: 80px;
      /* Fixed height */
      border-radius: 50%;
      /* Perfect circle */
      background: #d1d5db;
      flex-shrink: 0;
      /* Prevent shrinking when text is long */
    }

    #info-term-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 4px 0;
    }

    #info-term-progress {
      height: 100%;
      background: #3b82f6;
      width: 0%;
    }

    #info-term {
      text-align: center;
      margin-bottom: 20px;
    }

    #info-term-dates {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
    }

    #info-term-label {
      font-size: 10px;
      letter-spacing: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .term-nav-arrow {
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: #6b7280;
      transition: background-color 0.2s;
    }

    .term-nav-arrow:hover {
      background-color: #f3f4f6;
      color: #111827;
    }

    .term-nav-arrow svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    #info-header-name {
      font-size: 28px;
      font-weight: 700;
    }

    #info-mayor-name {
      font-size: 20px;
      font-weight: 700;
      font-weight: 700;
      line-height: 1;
    }

    #info-header-population {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    /* Vote Bar Styles */
    .vote-bar-container {
      margin-top: 10px;
    }

    .vote-bar-bg {
      width: 100%;
      height: 6px;
      background: #bfdbfe;
      /* Light Blue 200 */
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .vote-bar-fill {
      height: 100%;
      background: #1d4ed8;
      /* Intense Blue 700 */
      width: 0%;
      transition: width 1s ease-out;
    }

    .vote-stats {
      display: flex;
      justify-content: space-between;
      font-size: 7px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      text-shadow: 0 1px 2px rgba(255, 255, 255, .8);
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>

    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="Busca una comuna, provincia o región (ej: Arica, Valparaíso…)"
          autocomplete="off" />
      </div>
      <div id="suggestions" class="suggestions"></div>
      <div class="hint">Doble clic en una comuna para centrarla. Pasa el mouse para ver el nombre.</div>
    </div>

    <div id="chip" class="chip">Cargando mapa…</div>
    <div id="comune-info-card">
      <div id="INFOCARD-HEADER">
        <div id="info-header-type">Comuna</div>
        <div id="info-header-name"></div>
        <div id="info-header-region"></div>
        <div id="info-header-population"></div>
      </div>
      <div id="INFOCARD-COMMUNE">
        <div id="info-mayor">
          <div id="info-mayor-photo"></div>
          <div id="info-mayor-details">
            <div id="info-mayor-title"></div>
            <div id="info-mayor-name"></div>
            <div id="info-mayor-party"></div>
          </div>
        </div>
        <div id="info-votes"></div>
        <hr />
        <div id="info-term">
          <div id="info-term-label">
            <div role="button" tabindex="0" class="term-nav-arrow" id="term-prev" aria-label="Previous Period">
              <svg viewBox="0 0 320 512">
                <path
                  d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 278.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z" />
              </svg>
            </div>
            <span>PERÍODO</span>
            <div role="button" tabindex="0" class="term-nav-arrow" id="term-next" aria-label="Next Period">
              <svg viewBox="0 0 320 512">
                <path
                  d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 41.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z" />
              </svg>
            </div>
          </div>
          <div id="info-term-bar">
            <div id="info-term-progress"></div>
          </div>
          <div id="info-term-dates">
            <span id="info-term-start"></span>
            <span id="info-term-end"></span>
          </div>
        </div>
        <hr />
        <div id="info-concejales">
          <div style="font-size: 10px; letter-spacing: 4px; margin-bottom: 8px;">CONCEJALES:</div>
          <div id="info-concejales-list"></div>
        </div>
        <hr />
        <hr />
        <!-- info-population removed from here -->
        <div id="info-budget"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Parámetros y rutas ---
    const params = new URLSearchParams(location.search);
    const API_KEY = params.get('api_key') || '';

    // Default to RM if no hash or state
    const DEFAULT_REGION_FILE = 'comunas_rm_oficial_wgs84.geojson';
    const INDEX_URL = '../geojson/search_index.json';

    const { __, sprintf } = window.wp?.i18n || {
      __: s => s,
      sprintf: (s, ...a) => s.replace(/%s/g, () => a.shift())
    };

    // --- Estado ---
    let map, highlighted = null;
    let masterIndex = []; // The global search index
    let currentRegionFile = null;
    let currentRegionData = new Map(); // Index of features in the current view

    // Temporal Navigation State
    let currentDate = new Date(); // To simulate "Active Date"
    let currentEntityName = null;
    let currentEntityType = 'Comuna';

    // --- Utils ---
    const norm = s => (s || '').toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();

    const toTitleCase = s => {
      if (!s) return s;
      return s.toLowerCase().split(' ').map(word => {
        if (['de', 'del', 'la', 'las', 'los', 'y', 'e'].includes(word)) return word;
        return word.charAt(0).toUpperCase() + word.slice(1);
      }).join(' ');
    };

    function featureName(feature) {
      // Try Comuna Name
      let v = feature.getProperty('Comuna') || feature.getProperty('COMUNA') || feature.getProperty('NOM_COMUNA') || feature.getProperty('name');
      if (v) return v;
      // Try Provincia Name
      v = feature.getProperty('Provincia') || feature.getProperty('PROVINCIA');
      if (v) return v;
      // Try Region Name (rare on map features generally, but possible)
      v = feature.getProperty('Region');
      if (v) return v;

      return 'Sin nombre';
    }

    function styleFeature(feature) {
      const isH = !!feature.getProperty('isHighlighted');
      return {
        fillColor: isH ? '#3b82f6' : '#2563eb',
        fillOpacity: isH ? 0.28 : 0.04,
        strokeColor: isH ? '#1d4ed8' : '#1e40af',
        strokeWeight: isH ? 2.6 : 1.6
      };
    }

    function highlight(feature) {
      if (highlighted && highlighted !== feature) highlighted.setProperty('isHighlighted', false);
      highlighted = feature;
      if (feature) feature.setProperty('isHighlighted', true);
      map.data.setStyle(styleFeature);
    }

    // --- Data Loading & Info ---

    async function loadRegion(filename) {
      if (currentRegionFile === filename) return; // Already loaded

      document.getElementById('chip').textContent = 'Cargando región...';

      // Clear Map Data
      map.data.forEach(f => map.data.remove(f));
      currentRegionData.clear();
      highlighted = null;

      // Load new GeoJSON
      const url = `../geojson/${filename}`;

      return new Promise((resolve) => {
        map.data.loadGeoJson(url, null, (features) => {
          currentRegionFile = filename;

          // Build local index for mouse interactions
          features.forEach(f => {
            const name = featureName(f);
            if (name) {
              currentRegionData.set(norm(name), f);
            }
          });

          // Zoom to extent
          const bounds = new google.maps.LatLngBounds();
          features.forEach(f => {
            f.getGeometry().forEachLatLng(p => bounds.extend(p));
          });
          map.fitBounds(bounds);

          document.getElementById('chip').textContent = 'Mapa listo.';
          resolve();
        });
      });
    }

    async function showInfo(name, type = 'Comuna', dateObj = null) {
      // Update State
      currentEntityName = name;
      currentEntityType = type;
      if (dateObj) currentDate = dateObj; // Only update if passed explicitly, else keep current nav state

      const targetDateStr = currentDate.toISOString().slice(0, 10); // YYYY-MM-DD

      const box = document.getElementById('comune-info-card');
      const headerType = document.getElementById('info-header-type');

      if (headerType) {
        // Map type "Region" -> "Región" for display
        headerType.textContent = (type === 'Region') ? 'Región' : ((type === 'District') ? 'Distrito' : type);
      }

      const headerName = document.getElementById('info-header-name');
      const headerRegion = document.getElementById('info-header-region');
      const mayorTitle = document.getElementById('info-mayor-title');
      const mayorName = document.getElementById('info-mayor-name');
      const mayorParty = document.getElementById('info-mayor-party');
      const termStart = document.getElementById('info-term-start');
      const termEnd = document.getElementById('info-term-end');
      const termProgress = document.getElementById('info-term-progress');
      // const votesEl = document.getElementById('info-votes'); // Removed duplicate
      const votesEl = document.getElementById('info-votes');
      const populationEl = document.getElementById('info-header-population');
      const budgetEl = document.getElementById('info-budget');
      const concejalesList = document.getElementById('info-concejales-list');

      // Clear previous
      if (headerName) headerName.textContent = name;
      if (headerRegion) headerRegion.textContent = '';
      if (mayorTitle) mayorTitle.textContent = '';
      if (mayorName) mayorName.textContent = 'Cargando...';
      if (mayorParty) mayorParty.textContent = '';
      if (termStart) termStart.textContent = '';
      if (termEnd) termEnd.textContent = '';
      if (termProgress) termProgress.style.width = '0%';
      if (votesEl) votesEl.textContent = '';
      if (concejalesList) concejalesList.innerHTML = '';
      if (populationEl) populationEl.textContent = '';
      if (budgetEl) budgetEl.textContent = '';

      box.style.display = 'block';

      // --- District / Circunscripción Special Handling ---
      if (type === 'District' || type === 'Distrito' || type === 'Circunscripción') {
        if (headerName) headerName.textContent = name;

        // Hide standard sections not needed for District/Circ
        if (document.getElementById('info-mayor')) document.getElementById('info-mayor').style.display = 'none';
        if (document.getElementById('info-mayor-photo')) document.getElementById('info-mayor-photo').style.display = 'none';

        if (votesEl) votesEl.style.display = 'none';
        if (concejalesList) document.getElementById('info-concejales').style.display = 'none';
        if (budgetEl) budgetEl.style.display = 'none';

        // Show Period Nav
        if (termStart) termStart.textContent = '2022';
        if (termEnd) termEnd.textContent = '2030';

        // Let it fetch
      } else {
        // Reset displays for non-district (Comuna/Region/Circunscripción)
        if (document.getElementById('info-mayor')) document.getElementById('info-mayor').style.display = 'flex';
        if (document.getElementById('info-mayor-photo')) document.getElementById('info-mayor-photo').style.display = 'block';
        if (votesEl) votesEl.style.display = 'block';
        if (concejalesList) document.getElementById('info-concejales').style.display = 'block';
        if (budgetEl) budgetEl.style.display = 'block';
      }

      try {
        const res = await fetch(`/wp-json/politeia/v1/jurisdictions?name=${encodeURIComponent(name)}&date=${targetDateStr}`);
        if (res.ok) {
          const data = await res.json();
          if (data.found) {
            if (headerName && data.common_name) headerName.textContent = toTitleCase(data.common_name);
            if (headerRegion && data.parent_region_name) headerRegion.textContent = toTitleCase(data.parent_region_name);

            if (mayorTitle && data.office_title) mayorTitle.textContent = data.office_title;
            if (mayorName) mayorName.textContent = toTitleCase(data.person_name) || '';
            if (mayorParty && data.party_short_name) mayorParty.textContent = data.party_short_name;

            if (termStart) termStart.textContent = data.started_on || '';
            if (termEnd) termEnd.textContent = data.planned_end_on || '';

            // Re-show photo if we have one and we aren't in District/Circ mode 
            if (type !== 'District' && type !== 'Distrito' && type !== 'Circunscripción') {
              if (document.getElementById('info-mayor-photo')) document.getElementById('info-mayor-photo').style.display = 'block';
            }

            if (termProgress && data.started_on && data.planned_end_on) {
              const start = new Date(data.started_on);
              const end = new Date(data.planned_end_on);
              const now = new Date();
              const ratio = Math.min(Math.max((now - start) / (end - start), 0), 1);
              termProgress.style.width = (ratio * 100) + '%';
            }
            if (votesEl && type !== 'District' && type !== 'Distrito' && type !== 'Circunscripción') {
              if (data.votes && data.total_votes && Number(data.total_votes) > 0) {
                const v = Number(data.votes);
                const tv = Number(data.total_votes);
                const percent = Math.min((v / tv) * 100, 100);

                votesEl.innerHTML = `
                    <div class="vote-bar-container">
                        <div class="vote-bar-bg">
                        <div class="vote-bar-fill" style="width: ${percent}%;"></div>
                        </div>
                        <div class="vote-stats">
                        <span>Votos: ${v.toLocaleString('es-CL')}</span>
                        <span>Votantes: ${tv.toLocaleString('es-CL')}</span>
                        </div>
                    </div>`;
              } else if (data.votes) {
                // Fallback if no total_votes
                votesEl.textContent = sprintf('Votos: %s', Number(data.votes).toLocaleString('es-CL'));
              } else {
                votesEl.innerHTML = '';
              }
            }

            // Concejales logic
            if (concejalesList && type !== 'District' && type !== 'Distrito' && type !== 'Circunscripción') {
              try {
                const concRes = await fetch(`/wp-json/politeia/v1/concejales?name=${encodeURIComponent(name)}&date=${targetDateStr}`);
                if (concRes.ok) {
                  const concData = await concRes.json();
                  if (concData.found && concData.concejales && concData.concejales.length > 0) {
                    concejalesList.innerHTML = concData.concejales.map((c, i) =>
                      `<div style="font-size: 12px; margin-bottom: 4px;">${i + 1}. ${toTitleCase(c.name)}</div>`
                    ).join('');
                  } else {
                    concejalesList.innerHTML = '<div style="font-size: 12px; color: #6b7280;">No hay datos disponibles</div>';
                  }
                }
              } catch (e) { }
            }

            if (populationEl && data.population) {
              populationEl.textContent = sprintf('Población: %s', Number(data.population).toLocaleString('es-CL'));
            }
            if (budgetEl && data.budget) {
              budgetEl.textContent = `Presupuesto: $${Number(data.budget).toLocaleString('es-CL')}`;
            }

            // Show Debug Message if present (User requested "COULDNT FIND DATA" details)
            if (data.debug_message) {
              console.log('Debug:', data.debug_message);
              // We can append it to title or name if needed, or just log it.
              // For "COULDNT FIND DATA", see below in else block.
            }

          } else {
            console.log('API found: false', data);

            let msg = 'No hay datos disponibles.';
            if (data.debug_info) {
              msg += ' [DEBUG: ' + data.debug_info + ']';
            }
            if (mayorName) mayorName.textContent = msg;

            // Ensure container is visible to show message
            if (document.getElementById('info-mayor')) document.getElementById('info-mayor').style.display = 'flex';
          }
        }
      } catch (e) {
        if (mayorName) mayorName.textContent = 'Error al cargar datos. ' + e.message;
        if (document.getElementById('info-mayor')) document.getElementById('info-mayor').style.display = 'flex';
      }
    }

    // --- Search & Interaction ---

    function renderSuggestions(hits) {
      const box = document.getElementById('suggestions');
      if (!hits.length) { box.classList.remove('visible'); box.innerHTML = ''; return; }

      box.innerHTML = hits.map(hit => {
        // Display distinction: "Arica (Comuna)" vs "Arica (Provincia)"
        const typeLabel = hit.type === 'Region' ? 'Región' : hit.type;
        return `
        <div class="suggestion" data-key="${hit.key}" data-file="${hit.file}" data-type="${hit.type}" data-label="${hit.label}">
          <span>${hit.label}</span>
          <small>${typeLabel}</small>
        </div>`;
      }).join('');

      box.classList.add('visible');

      box.querySelectorAll('.suggestion').forEach(el => {
        el.addEventListener('click', () => {
          const item = {
            key: el.dataset.key,
            file: el.dataset.file,
            type: el.dataset.type,
            label: el.dataset.label
          };
          selectItem(item);
        });
      });
    }

    function search(q) {
      const nq = norm(q);
      if (!nq || nq.length < 2) return []; // Min 2 chars

      const hits = [];
      for (const item of masterIndex) {
        if (item.key.includes(nq)) {
          // Simple scoring: startsWith > includes
          const score = item.key.startsWith(nq) ? 0 : 1;
          hits.push({ ...item, score });
        }
      }

      hits.sort((a, b) => a.score - b.score || a.label.localeCompare(b.label));
      return hits.slice(0, 10);
    }

    async function selectItem(item) {
      // 1. Check if we need to load a different map file
      if (item.file !== currentRegionFile) {
        await loadRegion(item.file);
      }

      document.getElementById('q').value = item.label; // Update search bar immediately
      document.getElementById('suggestions').classList.remove('visible'); // Hide suggestions

      // Clear all previous highlights
      map.data.forEach(f => f.setProperty('isHighlighted', false));
      highlighted = null; // Reset single tracker

      if (item.type === 'Region') {
        // Show Chip
        document.getElementById('chip').textContent = item.label;
        // Show Info Card for the Region
        showInfo(item.label, 'Region');
        return;
      }

      if (item.type === 'District' || item.type === 'Distrito' || item.type === 'Circunscripción') {
        const isCirc = (item.type === 'Circunscripción');

        // Highlighting Logic for District/Circ (Multiple Communes)
        const bounds = new google.maps.LatLngBounds();
        let foundAny = false;

        // Communes list from the index item
        const communes = item.communes || [];
        // ... (highlighting logic remains the same)
        communes.forEach(cName => {
          const feature = currentRegionData.get(norm(cName));
          if (feature) {
            feature.setProperty('isHighlighted', true);
            feature.getGeometry().forEachLatLng(p => bounds.extend(p));
            foundAny = true;
          }
        });

        if (foundAny) {
          // Fit combined bounds
          const cardWidth = 350;
          const margin = 80;
          map.fitBounds(bounds, {
            top: margin,
            right: margin,
            bottom: margin,
            left: cardWidth + margin
          });
        } else {
          console.warn('No communes found for district:', item.label);
        }

        document.getElementById('chip').textContent = item.label;
        // Display Info
        // Pass specific type to showInfo
        showInfo(item.label, isCirc ? 'Circunscripción' : 'District');

        return;
      }

      // 2. Find feature in the now-loaded local data (Standard Comuna/Provincia)
      const feature = currentRegionData.get(norm(item.label));

      if (feature) {
        highlight(feature); // Use helper for single feature

        // 3. Zoom/Pan
        fitFeatureWithOffset(feature, {
          onDone: () => {
            // 4. Show Info
            showInfo(item.label, item.type);
          }
        });

        document.getElementById('chip').textContent = item.label;
      } else {
        console.warn('Feature not found in map data:', item.label);
        document.getElementById('chip').textContent = 'Mapa cargado, pero no se encontró el polígono.';
      }
    }

    // --- Fit & Pan Helper ---
    function fitFeatureWithOffset(feature, { onDone } = {}) {
      const bounds = new google.maps.LatLngBounds();
      feature.getGeometry().forEachLatLng(p => bounds.extend(p));

      // 1. Calculate bounding box dimensions (Height/Width ratio)
      const ne = bounds.getNorthEast();
      const sw = bounds.getSouthWest();
      const height = ne.lat() - sw.lat(); // Degrees latitude
      const width = ne.lng() - sw.lng(); // Degrees longitude

      // Simple heuristic: compare degrees directly (approximate but sufficient for this purpose)
      // or use aspect ratio of the bounding box vs viewport aspect ratio.
      // But user requested specific logic: "Is this shape wider or tall"
      const isPortrait = height > width;

      // 2. Define Available Viewport
      const cardWidth = 350;
      const margin = 80;
      const mapDiv = map.getDiv();
      const fullWidth = mapDiv.clientWidth;
      const fullHeight = mapDiv.clientHeight;

      // Available space for the map shape
      const safeWidth = fullWidth - cardWidth - (margin * 2);
      const safeHeight = fullHeight - (margin * 2);

      // 3. Fit Bounds with Padding
      // fitBounds() takes padding in pixels. We want to pad the LEFT side by (cardWidth + margin)
      // and others by margin.
      // This automatically handles the "centering" in the available space.
      map.fitBounds(bounds, {
        top: margin,
        right: margin,
        bottom: margin,
        left: cardWidth + margin
      });

      // Note: fitBounds with specific padding effectively places the bounds in the "safe zone"
      // defined by that padding. No manual panBy is needed if padding is correct!
      // However, if we want to ensure specific "largest dimension" fit logic:
      // Google Maps fitBounds does "contain" logic automatically.
      // If we provide the padding: left: 430px (350+80), right: 80px, top: 80px, bottom: 80px
      // It will fit the shape into the remaining rectangle (safeWidth x safeHeight).

      if (onDone) google.maps.event.addListenerOnce(map, 'idle', onDone);
    }

    // --- Init ---
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -33.45, lng: -70.66 }, zoom: 9,
        mapTypeControl: false, streetViewControl: false, fullscreenControl: true, clickableIcons: false,
        backgroundColor: '#e5e7eb', // Better background color for loading
      });
      map.data.setStyle(styleFeature);

      // Interactions
      map.data.addListener('mouseover', e => {
        const n = featureName(e.feature);
        if (n) document.getElementById('chip').textContent = n;
      });
      map.data.addListener('mouseout', e => {
        document.getElementById('chip').textContent = highlighted ? featureName(highlighted) : 'Politeia Map';
      });
      map.data.addListener('dblclick', e => {
        const name = featureName(e.feature);

        // Infer type from feature props (simplistic)
        // If it has 'Comuna' prop, it's Comuna. If 'Provincia' is the main name, it's that.
        // For standard clicks we assume Comuna mode if using Comuna file.
        // We can check currentRegionFile to guess type if needed.

        highlight(e.feature);
        fitFeatureWithOffset(e.feature, { onDone: () => showInfo(name) });
        document.getElementById('q').value = name;
      });

      // Load Master Index & Districts
      Promise.all([
        fetch(INDEX_URL).then(r => r.json()),
        fetch('/wp-json/politeia/v1/districts').then(r => r.ok ? r.json() : [])
      ]).then(([idx, districts]) => {
        masterIndex = idx;

        // Process Districts
        // We need to map Districts to Files. 
        // We assume all communes of a district are in the same Region File (mostly true).
        // We find one of the communes in masterIndex to get the file.
        districts.forEach(d => {
          // Find a commune in index
          const sampleCommune = d.communes.find(cName => {
            const n = norm(cName);
            return masterIndex.find(i => i.key === n);
          });

          if (sampleCommune) {
            const indexEntry = masterIndex.find(i => i.key === norm(sampleCommune));
            if (indexEntry) {
              file = indexEntry.file;
              regionId = indexEntry.regionId;
            }
          }

          // Determine Type based on API field or name.
          // API field 'type' was added in class-districts.php.
          // Note: d.type might be 'Circunscripción' or 'District'.
          const dName = d.name.toUpperCase();
          const isSenatorial = d.type === 'Circunscripción' || d.name.includes('Circunscripción') || dName.includes('CIRCUNSCRIPCI');
          const typeLabel = (d.type === 'Circunscripción' || isSenatorial) ? 'Circunscripción' : 'District';

          // Add to master index
          masterIndex.push({
            label: d.name,
            key: norm(d.name), // Normalize for Consistent Searching
            type: typeLabel,
            file: file,
            regionId: regionId,
            communes: d.communes
          });
        });

        console.log('Master Index Loaded (including Districts/Circunscripciones):', masterIndex.length);
      }).catch(e => console.error('Failed to load search index/districts', e));

      // Initial Load: RM
      loadRegion(DEFAULT_REGION_FILE);

      // Search Listeners
      const input = document.getElementById('q');
      const box = document.getElementById('suggestions');

      input.addEventListener('input', () => renderSuggestions(search(input.value)));

      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const hits = search(input.value);
          if (hits.length) selectItem(hits[0]);
        } else if (e.key === 'Escape') box.classList.remove('visible');
      });

      document.addEventListener('click', e => { if (!e.target.closest('.toolbar')) box.classList.remove('visible'); });

      // Temporal Navigation Listeners
      document.getElementById('term-prev').addEventListener('click', () => navigatePeriod(-1));
      document.getElementById('term-next').addEventListener('click', () => navigatePeriod(1));
    };

    function navigatePeriod(direction) {
      if (!currentEntityName) return;

      // Logic: Context-Aware Jump
      // Commune/Region: 4 years
      // District: 8 years
      let years = 4;
      if (currentEntityType === 'Distrito' || currentEntityType === 'District') {
        years = 8;
      }

      // Adjust Year
      // We jump by 'years' amount from the current Active Date
      currentDate.setFullYear(currentDate.getFullYear() + (direction * years));

      // Refresh Info
      showInfo(currentEntityName, currentEntityType, currentDate);
    }

    if (API_KEY) {
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    } else {
      document.getElementById('chip').textContent = 'Falta api_key';
    }
  </script>
</body>

</html>